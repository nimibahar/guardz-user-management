name: ğŸš€ Deploy to Production

# Trigger only on pushes to main branch (when PRs are merged)
on:
  push:
    branches: [main]

# Security: Only allow one deployment at a time
concurrency:
  group: production-deployment
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to GCP
    runs-on: ubuntu-latest
    
    # Security: Only run if the actor is the repository owner
    if: github.actor == 'nimibahar'
    
    environment:
      name: production
      url: http://35.223.194.70
    
    steps:
      - name: ğŸ” Verify deployment permissions
        run: |
          echo "ğŸ” Deployment triggered by: ${{ github.actor }}"
          echo "ğŸ“ Commit SHA: ${{ github.sha }}"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ“¦ Repository: ${{ github.repository }}"
      
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ”‘ Setup SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.GCP_PRIVATE_KEY }}
      
      - name: ğŸ›¡ï¸ Add GCP server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.GCP_HOST || '35.223.194.70' }} >> ~/.ssh/known_hosts
          echo "âœ… Added GCP server to known hosts"
      
      - name: ğŸš€ Deploy to production
        env:
          GCP_PRIVATE_KEY: ${{ secrets.GCP_PRIVATE_KEY }}
          GCP_HOST: ${{ secrets.GCP_HOST || '35.223.194.70' }}
          GCP_USER: ${{ secrets.GCP_USER || 'candidate' }}
        run: |
          echo "ğŸš€ Starting automated deployment..."
          ./deploy.sh
      
      - name: âœ… Verify deployment
        run: |
          echo "ğŸ” Verifying deployment health..."
          
          # Wait for services to be ready
          sleep 30
          
          # Check backend health
          if curl -f "http://${{ secrets.GCP_HOST || '35.223.194.70' }}:8080/health"; then
            echo "âœ… Backend is healthy"
          else
            echo "âŒ Backend health check failed"
            exit 1
          fi
          
          # Check frontend accessibility
          if curl -f "http://${{ secrets.GCP_HOST || '35.223.194.70' }}"; then
            echo "âœ… Frontend is accessible"
          else
            echo "âŒ Frontend accessibility check failed"
            exit 1
          fi
          
          echo "ğŸ‰ Deployment verification successful!"
      
      - name: ğŸ“Š Deployment summary
        if: always()
        run: |
          echo "ğŸ“Š Deployment Summary"
          echo "==================="
          echo "ğŸŒ Frontend URL: http://${{ secrets.GCP_HOST || '35.223.194.70' }}"
          echo "ğŸ”Œ Backend API: http://${{ secrets.GCP_HOST || '35.223.194.70' }}:8080"
          echo "ğŸ‘¤ Deployed by: ${{ github.actor }}"
          echo "ğŸ• Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Status: Deployment successful"
          else
            echo "âŒ Status: Deployment failed"
          fi